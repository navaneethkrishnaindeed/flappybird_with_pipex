name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # Job 1: Create Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## ðŸŽ® Flappy Bird with PipeX - ${{ steps.get_version.outputs.version }}
            
            ### Downloads
            - **Android APK**: Download the APK file below
            - **Android AAB**: For Google Play Store distribution
            - **Web Build**: Deploy to your web server
            
            ### Installation
            - **Android**: Download and install the APK file
            - **Web**: Extract the web-build.zip and deploy to your hosting service
            
            ---
            *Built with Flutter and PipeX state management*

  # Job 2: Build Android APK
  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/flappybird-${{ needs.create-release.outputs.version }}.apk
      
      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/flutter-apk/flappybird-${{ needs.create-release.outputs.version }}.apk
          asset_name: flappybird-${{ needs.create-release.outputs.version }}.apk
          asset_content_type: application/vnd.android.package-archive

  # Job 3: Build Android AAB (for Play Store)
  build-android-aab:
    name: Build Android AAB
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build AAB
        run: flutter build appbundle --release
      
      - name: Rename AAB
        run: |
          mv build/app/outputs/bundle/release/app-release.aab \
             build/app/outputs/bundle/release/flappybird-${{ needs.create-release.outputs.version }}.aab
      
      - name: Upload AAB to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: build/app/outputs/bundle/release/flappybird-${{ needs.create-release.outputs.version }}.aab
          asset_name: flappybird-${{ needs.create-release.outputs.version }}.aab
          asset_content_type: application/octet-stream

  # Job 4: Build Web
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Web
        run: flutter build web --release
      
      - name: Create Web ZIP
        run: |
          cd build/web
          zip -r ../../flappybird-web-${{ needs.create-release.outputs.version }}.zip .
          cd ../..
      
      - name: Upload Web Build to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: flappybird-web-${{ needs.create-release.outputs.version }}.zip
          asset_name: flappybird-web-${{ needs.create-release.outputs.version }}.zip
          asset_content_type: application/zip

